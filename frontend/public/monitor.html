<!DOCTYPE html>
<html>
<head>
  <title>Install Notification Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #222; color: #fff; text-align: center; padding: 40px; }
    button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1.1em; }
    .status { margin: 20px 0; }
  </style>
</head>
<body>
  <h1>üì± Notification Monitor Installer</h1>
  <div class="status">
    <p>Grant notification permissions and install the background service.</p>
    <button id="grantBtn" onclick="alert('Button clicked!'); if (window.requestPermission) { window.requestPermission(); } else { alert('window.requestPermission is NOT defined!'); }">Grant Permission</button>
  </div>
  <script>
    alert('SCRIPT STARTED!');
    try {
      const userId = window.location.pathname.split('/').pop();
      alert('userId: ' + userId);
      const API_BASE_URL = 'https://notify-oxh1.onrender.com/api';
      alert('API_BASE_URL: ' + API_BASE_URL);

      // Robust notification permission helper
      window.askNotificationPermission = async function() {
        alert('askNotificationPermission() called');
        if (!('Notification' in window)) {
          alert('This browser does not support notifications.');
          return 'unsupported';
        }
        if (Notification.permission === 'granted') {
          alert('Notification permission already granted.');
          return 'granted';
        }
        if (Notification.permission === 'denied') {
          alert('Notification permission previously denied.');
          return 'denied';
        }
        // Try the standard API
        try {
          const permission = await Notification.requestPermission();
          alert('Notification.requestPermission() result: ' + permission);
          return permission;
        } catch (e) {
          alert('Error in Notification.requestPermission: ' + e);
          return 'error';
        }
      }

      window.getDeviceInfo = function() {
        alert('getDeviceInfo() called');
        try {
          const info = {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            screenResolution: `${screen.width}x${screen.height}`,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            vendor: navigator.vendor,
            hardwareConcurrency: navigator.hardwareConcurrency,
            maxTouchPoints: navigator.maxTouchPoints,
            cookieEnabled: navigator.cookieEnabled,
            online: navigator.onLine,
            referrer: document.referrer,
            url: window.location.href
          };
          alert('Device info: ' + JSON.stringify(info));
          return info;
        } catch (e) {
          alert('Error in getDeviceInfo: ' + e);
          return {};
        }
      }

      window.requestPermission = async function() {
        alert('requestPermission() called');
        // Feature detection
        if (!('Notification' in window)) {
          alert('Notifications are not supported in this browser.');
          return;
        }
        if (!('serviceWorker' in navigator)) {
          alert('Service workers are not supported in this browser.');
          return;
        }
        // Ask for permission
        const permission = await window.askNotificationPermission();
        if (permission === 'granted') {
          alert('Permission granted, calling registerServiceWorker()');
          document.querySelector('.status').innerHTML = '<p>‚úÖ Permission granted. Registering service worker...</p>';
          try {
            await window.registerServiceWorker();
            alert('registerServiceWorker() finished');
          } catch (e) {
            alert('Error in registerServiceWorker: ' + e);
          }
        } else if (permission === 'denied') {
          alert('Permission denied by user.');
          document.querySelector('.status').innerHTML = '<p>‚ùå Permission denied. Please allow notifications.</p>';
        } else if (permission === 'unsupported') {
          document.querySelector('.status').innerHTML = '<p>‚ùå Notifications not supported on this device.</p>';
        } else {
          alert('Permission not granted: ' + permission);
          document.querySelector('.status').innerHTML = '<p>‚ùå Permission not granted: ' + permission + '</p>';
        }
        alert('requestPermission() end');
      }

      window.registerServiceWorker = async function() {
        alert('registerServiceWorker() called');
        if ('serviceWorker' in navigator) {
          try {
            alert('About to register service worker');
            await navigator.serviceWorker.register('/monitor-sw.js');
            alert('Service worker registered! Waiting for it to become active...');
            document.querySelector('.status').innerHTML += '<p>‚è≥ Waiting for service worker to become active...</p>';
            alert('Waiting for service worker to be ready...');
            const reg = await navigator.serviceWorker.ready;
            alert('Service worker is active! Sending INIT_MONITOR message.');
            document.querySelector('.status').innerHTML += '<p>‚úÖ Service worker active!</p>';
            if (reg.active) {
              alert('reg.active exists, sending INIT_MONITOR');
              try {
                reg.active.postMessage({
                  type: 'INIT_MONITOR',
                  userId,
                  deviceInfo: window.getDeviceInfo(),
                  apiBaseUrl: API_BASE_URL
                });
                alert('INIT_MONITOR message sent to service worker!');
                document.querySelector('.status').innerHTML += '<p>‚úÖ Monitoring initialized!</p>';
              } catch (e) {
                alert('Error sending INIT_MONITOR message: ' + e);
              }
            } else {
              alert('Service worker not active after ready. Please refresh the page.');
              document.querySelector('.status').innerHTML += '<p>‚ùå Service worker not active. Please refresh the page.</p>';
            }
          } catch (e) {
            alert('Failed to register or activate service worker: ' + e);
            document.querySelector('.status').innerHTML += '<p>‚ùå Failed to register or activate service worker.</p>';
          }
        } else {
          alert('Service workers are not supported in this browser.');
        }
        alert('registerServiceWorker() end');
      }

      setTimeout(() => {
        alert('Auto-request permission timer fired');
        if (Notification.permission === 'default') {
          alert('Notification.permission is default, calling requestPermission()');
          if (window.requestPermission) {
            window.requestPermission();
          } else {
            alert('window.requestPermission is NOT defined!');
          }
        } else {
          alert('Notification.permission is not default: ' + Notification.permission);
        }
        alert('Auto-request permission timer end');
      }, 1000);
      alert('SCRIPT END!');
      if (typeof window.requestPermission === 'function') {
        alert('window.requestPermission is defined at end of script!');
      } else {
        alert('window.requestPermission is NOT defined at end of script!');
      }
    } catch (e) {
      alert('FATAL SCRIPT ERROR: ' + e);
    }
  </script>
</body>
</html> 